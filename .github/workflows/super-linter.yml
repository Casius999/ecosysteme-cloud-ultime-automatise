name: Super-Linter - Analyse de code complÃ¨te

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/workflows/actionlint.yml'
  pull_request:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  schedule:
    - cron: '0 0 * * 3'  # ExÃ©cution hebdomadaire le mercredi Ã  minuit
  workflow_dispatch:
    inputs:
      reason:
        description: 'Raison de l''exÃ©cution manuelle'
        required: false
        default: 'VÃ©rification de la qualitÃ© du code'
      scope:
        description: 'Ã‰tendue de l''analyse'
        required: false
        default: 'changed'
        type: choice
        options:
          - changed
          - all

# DÃ©finition de la concurrence pour Ã©viter les exÃ©cutions parallÃ¨les inutiles
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# DÃ©finition des permissions minimales requises
permissions:
  contents: read
  security-events: write
  issues: write

jobs:
  super-lint:
    name: Super-Linter
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Augmentation du timeout pour les analyses complÃ¨tes
    env:
      # Configuration par dÃ©faut
      DEFAULT_BRANCH: main
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      LINTER_RULES_PATH: .github/linters
      LOG_LEVEL: NOTICE
      OUTPUT_DETAILS: detailed
      OUTPUT_FORMAT: sarif
      SARIF_REPORTER: true
      REPORT_SARIF_FILE: super-linter-report.sarif
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
        with:
          # Profondeur complÃ¨te pour l'analyse des changements
          fetch-depth: ${{ github.event.inputs.scope == 'all' || github.event_name == 'schedule' && '0' || '1' }}

      - name: PrÃ©paration du rÃ©pertoire des configurations
        run: |
          mkdir -p .github/linters

      - name: CrÃ©ation de configurations spÃ©cifiques
        run: |
          # Configuration Markdown
          cat > .github/linters/.markdownlint.yml << EOF
          default: true
          MD013:
            line_length: 120
          MD033: false
          EOF
          
          # Configuration Python
          cat > .github/linters/.python-lint << EOF
          [MASTER]
          ignore=CVS,tests
          ignore-patterns=test_.*?py
          jobs=2
          
          [MESSAGES CONTROL]
          disable=C0111,I0011,I0012,W0704,W0142,W0212,W0232,W0613,W0702,R0201
          
          [REPORTS]
          output-format=text
          reports=yes
          evaluation=10.0 - ((float(5 * error + warning + refactor + convention) / statement) * 10)
          EOF
          
          # Configuration ESLint
          cat > .github/linters/.eslintrc.yml << EOF
          env:
            browser: true
            es6: true
            node: true
          extends:
            - eslint:recommended
          parserOptions:
            ecmaVersion: 2022
            sourceType: module
          root: true
          rules:
            no-console: 'off'
          EOF
          
          # Configuration Terraform
          cat > .github/linters/.tflint.hcl << EOF
          plugin "aws" {
            enabled = true
            version = "0.21.1"
            source  = "github.com/terraform-linters/tflint-ruleset-aws"
          }
          
          rule "terraform_deprecated_index" {
            enabled = true
          }
          
          rule "terraform_unused_declarations" {
            enabled = true
          }
          
          rule "terraform_comment_syntax" {
            enabled = true
          }
          
          rule "terraform_documented_outputs" {
            enabled = true
          }
          
          rule "terraform_documented_variables" {
            enabled = true
          }
          
          rule "terraform_typed_variables" {
            enabled = true
          }
          
          rule "terraform_naming_convention" {
            enabled = true
          }
          
          rule "terraform_required_version" {
            enabled = true
          }
          EOF

      - name: DÃ©terminer l'Ã©tendue de l'analyse
        id: scope
        run: |
          if [[ "${{ github.event_name }}" == "schedule" || "${{ github.event.inputs.scope }}" == "all" ]]; then
            echo "VALIDATE_ALL_CODEBASE=true" >> $GITHUB_ENV
            echo "scope=all" >> $GITHUB_OUTPUT
            echo "Analyse complÃ¨te de tout le code"
          else
            echo "VALIDATE_ALL_CODEBASE=false" >> $GITHUB_ENV
            echo "scope=changed" >> $GITHUB_OUTPUT
            echo "Analyse limitÃ©e aux fichiers modifiÃ©s"
          fi

      - name: Configuration des validateurs basÃ©e sur le contenu du dÃ©pÃ´t
        id: validators
        run: |
          # Configuration par dÃ©faut de tous les validateurs
          echo "VALIDATE_TERRAFORM=true" >> $GITHUB_ENV
          echo "VALIDATE_KUBERNETES=true" >> $GITHUB_ENV
          echo "VALIDATE_YAML=true" >> $GITHUB_ENV
          echo "VALIDATE_JSON=true" >> $GITHUB_ENV
          echo "VALIDATE_MARKDOWN=true" >> $GITHUB_ENV
          echo "VALIDATE_BASH=true" >> $GITHUB_ENV
          echo "VALIDATE_PYTHON=true" >> $GITHUB_ENV
          echo "VALIDATE_JAVASCRIPT=true" >> $GITHUB_ENV
          echo "VALIDATE_DOCKERFILE=true" >> $GITHUB_ENV
          echo "VALIDATE_GITHUB_ACTIONS=true" >> $GITHUB_ENV
          
          # Configuration des filtres
          echo "FILTER_REGEX_INCLUDE=.*" >> $GITHUB_ENV
          echo "FILTER_REGEX_EXCLUDE=(.*\/node_modules\/.*|.*\/\.git\/.*|.*\/\.terraform\/.*)" >> $GITHUB_ENV
          
          # Ajout de validateurs supplÃ©mentaires basÃ©s sur la prÃ©sence de fichiers spÃ©cifiques
          if [ -f "package.json" ]; then
            echo "VALIDATE_TYPESCRIPT=true" >> $GITHUB_ENV
            echo "VALIDATE_HTML=true" >> $GITHUB_ENV
            echo "VALIDATE_CSS=true" >> $GITHUB_ENV
            echo "VALIDATE_JAVASCRIPT_ES=true" >> $GITHUB_ENV
            echo "TypeScript/JavaScript dÃ©tectÃ©s" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f "requirements.txt" ] || [ -f "pyproject.toml" ] || [ -f "setup.py" ]; then
            echo "VALIDATE_PYTHON_BLACK=true" >> $GITHUB_ENV
            echo "VALIDATE_PYTHON_FLAKE8=true" >> $GITHUB_ENV
            echo "VALIDATE_PYTHON_ISORT=true" >> $GITHUB_ENV
            echo "VALIDATE_PYTHON_MYPY=true" >> $GITHUB_ENV
            echo "Python dÃ©tectÃ©" >> $GITHUB_STEP_SUMMARY
          fi
          
          if ls *.tfvars 2>/dev/null || [ -d "terraform" ]; then
            echo "VALIDATE_TERRAFORM_TFLINT=true" >> $GITHUB_ENV
            echo "Terraform dÃ©tectÃ©" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ExÃ©cution de Super-Linter
        id: lint
        uses: github/super-linter/slim@v5  # Utilisation de la version "slim" pour des performances amÃ©liorÃ©es
        env:
          VALIDATE_ALL_CODEBASE: ${{ env.VALIDATE_ALL_CODEBASE }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEFAULT_BRANCH: main
          LINTER_RULES_PATH: .github/linters
          LOG_LEVEL: NOTICE
          OUTPUT_DETAILS: detailed
          OUTPUT_FORMAT: sarif
          SARIF_REPORTER: true
          REPORT_SARIF_FILE: super-linter-report.sarif
          DISABLE_ERRORS: false  # Nous voulons que le workflow Ã©choue si des erreurs sont trouvÃ©es

      - name: TÃ©lÃ©versement du rapport SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: super-linter-report.sarif
          category: super-linter

      - name: GÃ©nÃ©ration d'un rapport Markdown
        if: always()
        run: |
          mkdir -p reports
          
          # RÃ©cupÃ©rer le statut de l'Ã©tape prÃ©cÃ©dente
          LINT_STATUS="${{ steps.lint.outcome }}"
          
          # DÃ©terminer le rÃ©sultat de l'analyse
          if [ "$LINT_STATUS" == "success" ]; then
            RESULT_ICON="âœ…"
            RESULT_TEXT="SuccÃ¨s"
            DETAILS="Aucun problÃ¨me dÃ©tectÃ© dans le code."
          else
            RESULT_ICON="âŒ"
            RESULT_TEXT="Ã‰chec"
            DETAILS="Des problÃ¨mes ont Ã©tÃ© dÃ©tectÃ©s dans le code. Consultez les dÃ©tails dans le rapport SARIF."
          fi
          
          # CrÃ©er le rapport
          cat > reports/super-linter-report.md << EOF
# Rapport Super-Linter

Date d'exÃ©cution: $(date)
Commit: ${{ github.sha }}
Ã‰tendue de l'analyse: ${{ steps.scope.outputs.scope }}

$RESULT_ICON **RÃ©sultat: $RESULT_TEXT**

$DETAILS

## DÃ©tails de l'analyse

- ExÃ©cution sur la branche: ${{ github.ref_name }}
- DÃ©clenchÃ©e par: ${{ github.event_name }}
- Utilisateur: ${{ github.actor }}

## Actions Ã  prendre

$( [ "$LINT_STATUS" == "success" ] && echo "- Continuez Ã  maintenir la qualitÃ© du code" || echo "- Consultez les dÃ©tails dans les journaux de GitHub Actions\n- Corrigez les problÃ¨mes dÃ©tectÃ©s\n- ExÃ©cutez Ã  nouveau l'analyse")

## Outils utilisÃ©s

- [GitHub Super-Linter](https://github.com/github/super-linter)
- Version: v5
EOF

      - name: TÃ©lÃ©chargement du rapport
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: linter-reports
          path: reports/
          retention-days: 90

      - name: CrÃ©ation d'une issue pour les problÃ¨mes dÃ©tectÃ©s
        if: failure() && steps.lint.outcome == 'failure'
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "ðŸ” ProblÃ¨mes de qualitÃ© de code dÃ©tectÃ©s par Super-Linter"
          content-filepath: reports/super-linter-report.md
          labels: code-quality, linting, maintenance, automation
          assignees: ${{ github.repository_owner }}

      - name: RÃ©sumÃ© des rÃ©sultats
        if: always()
        run: |
          echo "## RÃ©sultats de l'analyse Super-Linter" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.lint.outcome }}" == "success" ]; then
            echo "âœ… **SuccÃ¨s - Aucun problÃ¨me dÃ©tectÃ©**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Ã‰chec - Des problÃ¨mes ont Ã©tÃ© dÃ©tectÃ©s**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Une issue a Ã©tÃ© crÃ©Ã©e pour suivre ces problÃ¨mes." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Ã‰tendue de l'analyse : **${{ steps.scope.outputs.scope }}**" >> $GITHUB_STEP_SUMMARY
